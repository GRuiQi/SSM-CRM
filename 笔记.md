[TOC]

看视频，跟着敲代码，跟不上。

边看视频边做笔记...

视频比较古老，可能有些插件，依赖不兼容。



## 前言

实际开发一般不会有那么多东西需要配置，更多时候你的工作是：

- 分析需求
- 建表
- 接口开发：Controller/Service/Dao
- 前端开发：js/html/css/vue/react

你需要写很多的if判断、for循环，需要处理异常，需要封装Pojo，需要结合业务考虑如何把代码写得更加合理。你可能还需要思考：

- 如何借助Spring写一个工具类来获取bean？（要考虑bean的生命周期）
- 如何在Service层得到Session来存储对象？（不要从Controller传进来）
- 如何利用AOP做用户登录日志？日志工具类发生事务嵌套如何解决？
- 如何把查询出来的员工列表导出为EXCEL？
- 如何上传图片？
- 为什么Spring的@Autowired无法为静态字段自动注入？
- 前台编辑时，到底是重新根据id查询，还是直接拿现有的数据展示？
- 前台页面、Java代码、数据库的日期如何处理？
- 如何做权限管理？更加细粒度的呢？菜单权限、按钮权限？
- 拦截器如果拦截请求发现用户没有权限，怎么处理？重定向页面还是返回json？
- 甚至你需要考虑到底用枚举还是静态常量
- ....

是不是觉得很琐碎？但这才是实际项目，这才是工作常态，而不是说你会搭一个SpringCloud或者Dubbo项目就等于掌握了分布式。

无论是分布式还是单体应用，真正支撑你完成需求的，应该是你的编码能力，而不是这些花里胡哨的技术（当然，你真能掌握是极好的）。技术永远要为业务服务，否则也不会有技术选型这个环节，直接上最新最屌的技术岂不美哉？



小码哥的这个CRM管理系统，总共3天时间，适合刚学完SSM的萌新：

- 需求分析

- Spring+SpringMVC+MyBatis+Maven+lombok+EasyUI

- 登录首页

- 登录拦截

- 员工/部门/角色/权限管理

- - 增删改查
  - 高级查询+分页

- 基于AOP的系统日志（涉及事务传播的处理）

- RBAC权限管理

- - url权限控制
  - 按钮权限控制
  - 菜单权限控制

- EXCEL导入导出

很多人可能觉得似乎很简单，但有很多隐藏的坑等着你去解决。而且，你摸着自己的胸问问：你多久没从头到尾敲完一个项目了？

这个项目代码量不多不少，大概三天可以敲完，能让刚学完SSM的萌新在实际编码方面得到极大的锻炼和提升，尤其在前端方面。该项目接近外包。

## day01

需要锻炼独立思考需求并且完成的能力



### 需求

系统管理 模块





### mybatis-generator

mybatis-generator:generate

1. 在pom.xml文件引入插件依赖

   ```xml
    <!--逆向工程插件-->
   <plugin>
       <groupId>org.mybatis.generator</groupId>
       <artifactId>mybatis-generator-maven-plugin</artifactId>
       <version>1.3.2</version>
       <configuration>
           <verbose>true</verbose>
           <overwrite>false</overwrite>
       </configuration>
       <dependencies>
           <dependency>
               <groupId>mysql</groupId>
               <artifactId>mysql-connector-java</artifactId>
               <version>5.1.21</version>
           </dependency>
       </dependencies>
   </plugin>
   ```

   

2. 在数据库中创建表

3. 在资源目录添加这个文件 generatorConfig.xml

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE generatorConfiguration
     PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
   "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
   <!-- 配置生成器 -->
   <generatorConfiguration>
   
   	<context id="mysql" defaultModelType="hierarchical"
   		targetRuntime="MyBatis3Simple">
   
   		<!-- 自动识别数据库关键字，默认false，如果设置为true，根据SqlReservedWords中定义的关键字列表； 一般保留默认值，遇到数据库关键字（Java关键字），使用columnOverride覆盖 -->
   		<property name="autoDelimitKeywords" value="false" />
   		<!-- 生成的Java文件的编码 -->
   		<property name="javaFileEncoding" value="UTF-8" />
   		<!-- 格式化java代码 -->
   		<property name="javaFormatter"
   			value="org.mybatis.generator.api.dom.DefaultJavaFormatter" />
   		<!-- 格式化XML代码 -->
   		<property name="xmlFormatter"
   			value="org.mybatis.generator.api.dom.DefaultXmlFormatter" />
   
   		<!-- beginningDelimiter和endingDelimiter：指明数据库的用于标记数据库对象名的符号，比如ORACLE就是双引号，MYSQL默认是`反引号； -->
   		<property name="beginningDelimiter" value="`" />
   		<property name="endingDelimiter" value="`" />
   
   		<commentGenerator>
   			<property name="suppressDate" value="true" />
   			<property name="suppressAllComments" value="true" />
   		</commentGenerator>
   
   		<!-- 必须要有的，使用这个配置链接数据库 @TODO:是否可以扩展 -->
   		<jdbcConnection driverClass="com.mysql.jdbc.Driver"
   			connectionURL="jdbc:mysql:///crm" userId="root" password="root">
   			<!-- 这里面可以设置property属性，每一个property属性都设置到配置的Driver上 -->
   		</jdbcConnection>
   
   		<!-- java类型处理器 用于处理DB中的类型到Java中的类型，默认使用JavaTypeResolverDefaultImpl； 注意一点，默认会先尝试使用Integer，Long，Short等来对应DECIMAL和 
   			NUMERIC数据类型； -->
   		<javaTypeResolver
   			type="org.mybatis.generator.internal.types.JavaTypeResolverDefaultImpl">
   			<!-- true：使用BigDecimal对应DECIMAL和 NUMERIC数据类型 false：默认, scale>0;length>18：使用BigDecimal; 
   				scale=0;length[10,18]：使用Long； scale=0;length[5,9]：使用Integer； scale=0;length<5：使用Short； -->
   			<property name="forceBigDecimals" value="false" />
   		</javaTypeResolver>
   
   
   		<!-- java模型创建器，是必须要的元素 负责：1，key类（见context的defaultModelType）；2，java类；3，查询类 
   			targetPackage：生成的类要放的包，真实的包受enableSubPackages属性控制； targetProject：目标项目，指定一个存在的目录下，生成的内容会放到指定目录中，如果目录不存在，MBG不会自动建目录 -->
   		<javaModelGenerator targetPackage="com._520it.crm.domain"
   			targetProject="src/main/java">
   			<!-- for MyBatis3/MyBatis3Simple 自动为每一个生成的类创建一个构造方法，构造方法包含了所有的field；而不是使用setter； -->
   			<property name="constructorBased" value="false" />
   
   			<!-- for MyBatis3 / MyBatis3Simple 是否创建一个不可变的类，如果为true， 那么MBG会创建一个没有setter方法的类，取而代之的是类似constructorBased的类 -->
   			<property name="immutable" value="false" />
   
   			<!-- 设置是否在getter方法中，对String类型字段调用trim()方法 -->
   			<property name="trimStrings" value="true" />
   		</javaModelGenerator>
   
   		<!-- 生成SQL map的XML文件生成器， 注意，在Mybatis3之后，我们可以使用mapper.xml文件+Mapper接口（或者不用mapper接口）， 
   			或者只使用Mapper接口+Annotation，所以，如果 javaClientGenerator配置中配置了需要生成XML的话，这个元素就必须配置 
   			targetPackage/targetProject:同javaModelGenerator -->
   		<sqlMapGenerator targetPackage="com._520it.crm.mapper"
   			targetProject="src/main/java">
   			<!-- 在targetPackage的基础上，根据数据库的schema再生成一层package，最终生成的类放在这个package下，默认为false -->
   			<property name="enableSubPackages" value="true" />
   		</sqlMapGenerator>
   
   
   		<!-- 对于mybatis来说，即生成Mapper接口，注意，如果没有配置该元素，那么默认不会生成Mapper接口 targetPackage/targetProject:同javaModelGenerator 
   			type：选择怎么生成mapper接口（在MyBatis3/MyBatis3Simple下）： 1，ANNOTATEDMAPPER：会生成使用Mapper接口+Annotation的方式创建（SQL生成在annotation中），不会生成对应的XML； 
   			2，MIXEDMAPPER：使用混合配置，会生成Mapper接口，并适当添加合适的Annotation，但是XML会生成在XML中； 3，XMLMAPPER：会生成Mapper接口，接口完全依赖XML； 
   			注意，如果context是MyBatis3Simple：只支持ANNOTATEDMAPPER和XMLMAPPER -->
   		<javaClientGenerator targetPackage="com._520it.crm.mapper"
   			type="XMLMAPPER" targetProject="src/main/java">
   			<!-- 在targetPackage的基础上，根据数据库的schema再生成一层package，最终生成的类放在这个package下，默认为false -->
   			<property name="enableSubPackages" value="true" />
   
   			<!-- 可以为所有生成的接口添加一个父接口，但是MBG只负责生成，不负责检查 <property name="rootInterface" 
   				value=""/> -->
   		</javaClientGenerator>
   
   		<table tableName="menu">
   			<!-- 参考 javaModelGenerator 的 constructorBased属性 -->
   			<property name="constructorBased" value="false" />
   			<generatedKey column="id" sqlStatement="JDBC" />
   		</table>
   	</context>
   </generatorConfiguration>
   ```

   mybatis-genrator基本使用

   ![image-20201007101704425](https://qiyewuan-1302629736.cos.ap-nanjing.myqcloud.com/img/image-20201007101704425.png)



实体类和crud可以自动生成，但是一些关联关系是无法生成的。需要我们自己去修改。

这个代码不能运行多次，如果运行多次会在生成的文件中追加内容



集成spring,mybatis



测试EmployeeServiceImpl

#### idea生成测试类

在 src目录下新建test文件夹

右键-> go to -> test



集成springMVC , 配置web.xml





### 系统拦截

登陆才能访问index.jsp



#### 关于SpringMVC的Interceptor

springmvc执行流程

![image-20201007224928961](https://qiyewuan-1302629736.cos.ap-nanjing.myqcloud.com/img/image-20201007224928961.png)

> 拦截器会在该流程中拦截/放行url请求
>
> 拦截器使用：
>
> 实现 HandlerInterceptor接口
>
> 重写  三个方法
>
> preHandle 
>
> ```
> 在控制器执行之前完成业务逻辑操作 也就是DispatcherServlet
> 方法的返回值决定逻辑是否继续执行。true代表继续执行；false代表不再继续执行
> ```
>
>  postHandle
>
> ```
> 在控制器执行完毕之后执行的逻辑操作
> ```
>
>  afterCompletion
>
> ```
> 在完成视图渲染之后，执行此方法。
> ```



**注：前端的url不会带上项目名称（比如window.location.href），后端的url会自动带上项目名称(controller的RequetsMapping("/login"))**

登陆：

EmployeeController 

![image-20200826224855113](https://qiyewuan-1302629736.cos.ap-nanjing.myqcloud.com/img/image-20200826224855113.png)



### 员工前台首页显示

这里使用到easyui https://www.jeasyui.net/plugins/183.html

#### easyui简单使用

![image-20200827000105515](https://qiyewuan-1302629736.cos.ap-nanjing.myqcloud.com/img/image-20200827000105515.png)







---



### 过滤器，监听器，拦截器



- 过滤器：

字符编码设置

- 监听器：

```
//将web应用名称（路径）保存到application范围中
/*${pageContext.request.contextPath}*/
```

- 拦截器：

登陆拦截，放行登陆界面

https://zhuanlan.zhihu.com/p/69060111





### 数据库和前台时间格式的转换

#### `@JsonFormat`

#### `@DateTimeFormat`

```java
/*日期类后台转到前台*/
@JsonFormat(timezone = "GMT+8",pattern = "yyyy-MM-dd")
/*日期类型前台转到后台*/
@DateTimeFormat(pattern = "yyyy-MM-dd")
private Date inputtime;
```





## day02



### 排错的思路

缩小范围

在代码的不同位置分别输出1,2,3

如果没有输出，则在输出语句附近寻找错误，可以输出一些变量的值





### 代码改进

#### 前端

1. 抽取变量

2. 将所有的方法统一的管理

   方法就是把函数放在对象里面，对象只有两个东西，属性和方法

   ```javascript
   var alice = {
               name: 'Alice',
               birth: 1998,
               age: function(){
                   var now = new Date().getFullYear();
                   return now - this.birth;
               }
           }
   
   //属性
   alice.name
   //方法
   alice.age()
   ```

   

3. 对按钮进行统一的监听?

   a便签里面的data-cmd属性是什么呢？命令？



#### 后端

将`Map<String,Object> result = new HashMap<>();`封装为AjaxResult



### 基于AOP的系统日志

如何处理日志？

以前的做法，就是写很多输出语句。

面向切面编程，可以在程序中动态的切入代码片段



对于核心的模块我们可以监护一下，用户有没有异常操作



```xml
 <!-- 事务模板：设置事务的一些属性-->
    <tx:advice id="advice">
        <tx:attributes>
            <!--设置所有读操作的事务为SUPPORRS，如果没有事务就不开启新事务-->
            <tx:method name="get*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="select*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="query*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="list*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="*"/>
        </tx:attributes>
    </tx:advice>

    <bean id="logUtil" class="com._520it.crm.util.LogUtil"></bean>

    <!-- AOP相关配置：这个就是把事务工具类当做AOP的一个adviser，加入到责任链中-->
    <aop:config>
        <!-- 给*Service添加事务 -->
        <aop:pointcut id="crudPointCut" expression="execution(* com._520it.crm.service.*Service.*(..))"/>
        <aop:advisor advice-ref="advice" pointcut-ref="crudPointCut"/>
        <!-- 给*Service添加日志方法（logiUtil的wtite方法） -->
        <aop:aspect ref="logUtil">
            <aop:after method="writeLog" pointcut-ref="crudPointCut"/>
        </aop:aspect>
    </aop:config>

<!-- 
pointcut:切点
advice:通知
aspect:切面
被增强的类：service包下的类
增强的类：logUtil 
-->
```



LogUtil

#### 从非web环境拿到web相关的参数？service和controller?



#### ThreadLocal http://www.threadlocal.cn/



![ssm-crm 3](https://qiyewuan-1302629736.cos.ap-nanjing.myqcloud.com/img/ssm-crm 3.png)

> 事务传播行为默认是REQUIRED



### 系统权限管理



## day03

dao接口传递参数时，要注意参数的顺序

多个参数记得用@Param("")

### URL 权限控制

